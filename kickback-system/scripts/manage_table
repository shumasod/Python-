#!/usr/bin/env python3
"""DynamoDB Localにテーブルを作成するスクリプト."""

import boto3


def create_table(endpoint_url: str = "http://localhost:8000"):
    """テーブルを作成."""
    dynamodb = boto3.client("dynamodb", endpoint_url=endpoint_url)

    try:
        dynamodb.create_table(
            TableName="CreditCardKickbacks",
            KeySchema=[
                {"AttributeName": "PK", "KeyType": "HASH"},
                {"AttributeName": "SK", "KeyType": "RANGE"},
            ],
            AttributeDefinitions=[
                {"AttributeName": "PK", "AttributeType": "S"},
                {"AttributeName": "SK", "AttributeType": "S"},
                {"AttributeName": "GSI1PK", "AttributeType": "S"},
                {"AttributeName": "GSI1SK", "AttributeType": "S"},
                {"AttributeName": "GSI2PK", "AttributeType": "S"},
                {"AttributeName": "GSI2SK", "AttributeType": "S"},
                {"AttributeName": "GSI3PK", "AttributeType": "S"},
                {"AttributeName": "GSI3SK", "AttributeType": "S"},
            ],
            GlobalSecondaryIndexes=[
                {
                    "IndexName": "CategoryIndex",
                    "KeySchema": [
                        {"AttributeName": "GSI1PK", "KeyType": "HASH"},
                        {"AttributeName": "GSI1SK", "KeyType": "RANGE"},
                    ],
                    "Projection": {"ProjectionType": "ALL"},
                },
                {
                    "IndexName": "CardIndex",
                    "KeySchema": [
                        {"AttributeName": "GSI2PK", "KeyType": "HASH"},
                        {"AttributeName": "GSI2SK", "KeyType": "RANGE"},
                    ],
                    "Projection": {"ProjectionType": "ALL"},
                },
                {
                    "IndexName": "TimeIndex",
                    "KeySchema": [
                        {"AttributeName": "GSI3PK", "KeyType": "HASH"},
                        {"AttributeName": "GSI3SK", "KeyType": "RANGE"},
                    ],
                    "Projection": {
                        "ProjectionType": "INCLUDE",
                        "NonKeyAttributes": ["userId", "kickbackAmount", "category", "cardId"],
                    },
                },
            ],
            BillingMode="PAY_PER_REQUEST",
        )
        print("Table created successfully!")

    except dynamodb.exceptions.ResourceInUseException:
        print("Table already exists")


def delete_table(endpoint_url: str = "http://localhost:8000"):
    """テーブルを削除."""
    dynamodb = boto3.client("dynamodb", endpoint_url=endpoint_url)

    try:
        dynamodb.delete_table(TableName="CreditCardKickbacks")
        print("Table deleted successfully!")
    except dynamodb.exceptions.ResourceNotFoundException:
        print("Table does not exist")


def main():
    """メイン処理."""
    import argparse

    parser = argparse.ArgumentParser(description="DynamoDB Localテーブル管理")
    parser.add_argument("action", choices=["create", "delete"], help="操作")
    parser.add_argument(
        "--endpoint",
        default="http://localhost:8000",
        help="DynamoDB endpoint URL",
    )
    args = parser.parse_args()

    if args.action == "create":
        create_table(args.endpoint)
    elif args.action == "delete":
        delete_table(args.endpoint)


if __name__ == "__main__":
    main()
